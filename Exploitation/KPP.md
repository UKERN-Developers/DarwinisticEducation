# Bypassing Kernel Patch Protection
Bypassing kernel patch protection in iOS

## About
Starting from iOS 9 all 64-bit ARM devices before the iPhone 7 have kernel patch protection implemented.  
This means that the kernel integrity is generally checked after a certain period, this is speculated to be +/- after 10 minutes.  
If the kernel is patched in the mean time and KPP detects this after 10 minutes, then the kernel will panic.  
Most jailbreaks are patching the parts of the kernel that are not checked by KPP at all, as there are enough structures outside the checked kernel regions that you can patch for providing a jailbreak.  
However, a smart kid and skilled researcher named Luca Todesco found a big design flaw in the implementation of KPP.  
Where we generally say KPP, we actually reffer to what Apple inc. calls WatchTower.  
WatchTower is loaded at boot and runs on exception Level 3, which is the highest exception level and as stated by ARM meant for monitoring.  
It works by walking over the kernel's pages and evaluating if modifications were made to a page where no modifications should be done.  
However, KPP ironically does not take in account that an attacker can use fake pages and apply patches there.  
This design flow discovered and exploited by Luca, made it possible to patch the regions normally protected by KPP making a jailbreak very easy.  
For example a KPP bypass is also needed for kloader, kloader is a utillity to bootstrap another bootchain from the already running system.  
Because it needs access to physical memory and also needs to alter many parts of the kernel to perform such a bootstrap, it relies on a KPP bypass.  
The flaw found by Todesco can not be patched as it is baked onto the system forever, Apple would need to revise hardware to patch it.  
In other words you would need to walk into an actual Apple Factory with your iPhone and have it patched there.  

## What does KPP check
Very simple: \_TEXT and \_DATA.\_\_const

## The bypass
Here is the chain of logic todesco performs to trick the KPP into thinking the kernel has not been patched.  
- Find the physical memory base address
- Find the active processor number (iPhones have more logical cores).  
- Find the pagesize, as pages should be made accordingly to that size and the size differs per device. (4K for below the 6S, 6S and up is 16K).
- Allocate memory for the chain of instructions.  
- Write the first instructions so that the kernel will jump into the new trampoline.  
- Craft the actual trampoline to refer to fake pages. 
- Copy kernel pages to the fake pages xD.  
- To prevent the kernel pages to be restored after a processor sleep, again write instructions to jump into the new trampoline after the sleep.  
- Trigger KPP walk.  
- Patch the fake pages and eat some popcorn and laugh while Mobile File Integrity, Mac policy ops and the rootfs mountpoint are patched.  

## Jailbreaks without dealing with KPP
As you already may have expected, this simply works by targeting structures in the \_DATA segment.  
These are not protected for writing neither checked by KPP and are sufficient for jailbreaking.  
